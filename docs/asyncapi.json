{
  "asyncapi": "2.6.0",
  "info": {
    "title": "Agreement Service Events",
    "version": "1.0.0",
    "description": "Event-driven messaging for the Farming Grants Agreements API. This service consumes agreement creation and update events from SQS queues, and publishes agreement status change notifications to SNS topics."
  },
  "channels": {
    "sqs/gas_create_agreement": {
      "description": "Queue for creating new agreements from the Grant Application Service (GAS). When a grant application is approved, GAS publishes a message to this queue to trigger agreement creation.",
      "subscribe": {
        "operationId": "handleCreateAgreementEvent",
        "summary": "Handle agreement creation from approved applications",
        "message": {
          "name": "CreateAgreementEvent",
          "title": "Create Agreement Event",
          "summary": "Event triggered when a grant application is approved and an agreement should be created",
          "contentType": "application/json",
          "payload": {
            "$ref": "#/components/schemas/CreateAgreementPayload"
          }
        }
      }
    },
    "sqs/gas_application_updated": {
      "description": "Queue for application status updates from GAS. Currently handles withdrawal events to update agreement status accordingly.",
      "subscribe": {
        "operationId": "handleUpdateAgreementEvent",
        "summary": "Handle application status updates (e.g., withdrawn)",
        "message": {
          "name": "UpdateAgreementEvent",
          "title": "Update Agreement Event",
          "summary": "Event triggered when an application status changes (e.g., withdrawn)",
          "contentType": "application/json",
          "payload": {
            "$ref": "#/components/schemas/UpdateAgreementPayload"
          }
        }
      }
    },
    "sns/agreement_status_updated": {
      "description": "SNS topic for agreement status change notifications. Published when an agreement is accepted by the farmer or withdrawn. Consumers include GAS and other downstream services.",
      "publish": {
        "operationId": "publishAgreementStatusUpdated",
        "summary": "Publish agreement status change notification",
        "message": {
          "name": "AgreementStatusUpdatedEvent",
          "title": "Agreement Status Updated Event",
          "summary": "CloudEvents 1.0 formatted notification when agreement status changes",
          "contentType": "application/json",
          "payload": {
            "$ref": "#/components/schemas/AgreementStatusUpdatedPayload"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "CreateAgreementPayload": {
        "type": "object",
        "description": "Payload for creating a new agreement from an approved application",
        "required": [
          "type",
          "data"
        ],
        "properties": {
          "type": {
            "type": "string",
            "description": "Event type identifier. Must contain \"gas-backend.agreement.create\" to trigger processing.",
            "example": "cloud.defra.dev.fg-gas-backend.agreement.create"
          },
          "data": {
            "type": "object",
            "description": "Agreement data from the approved application",
            "required": [
              "identifiers",
              "application"
            ],
            "properties": {
              "correlationId": {
                "type": "string",
                "description": "Unique identifier for tracing the request across services",
                "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
              },
              "clientRef": {
                "type": "string",
                "description": "Client reference number from the original application",
                "example": "client-ref-001"
              },
              "code": {
                "type": "string",
                "description": "Scheme code identifier",
                "example": "frps-private-beta"
              },
              "identifiers": {
                "$ref": "#/components/schemas/Identifiers"
              },
              "application": {
                "$ref": "#/components/schemas/Application"
              },
              "applicant": {
                "$ref": "#/components/schemas/Applicant"
              },
              "payment": {
                "$ref": "#/components/schemas/Payment"
              }
            }
          }
        }
      },
      "UpdateAgreementPayload": {
        "type": "object",
        "description": "Payload for updating an existing agreement status",
        "required": [
          "data"
        ],
        "properties": {
          "type": {
            "type": "string",
            "description": "Event type identifier",
            "example": "cloud.defra.dev.fg-gas-backend.application.updated"
          },
          "data": {
            "type": "object",
            "description": "Update data for the agreement",
            "required": [
              "clientRef",
              "agreementNumber",
              "status"
            ],
            "properties": {
              "clientRef": {
                "type": "string",
                "description": "Client reference number to identify the agreement",
                "example": "client-ref-001"
              },
              "agreementNumber": {
                "type": "string",
                "description": "Unique agreement number",
                "example": "SFI123456789"
              },
              "status": {
                "type": "string",
                "description": "New status for the agreement. Currently only \"withdrawn\" is processed.",
                "enum": [
                  "withdrawn"
                ],
                "example": "withdrawn"
              }
            }
          }
        }
      },
      "AgreementStatusUpdatedPayload": {
        "type": "object",
        "description": "CloudEvents 1.0 formatted payload for agreement status updates",
        "required": [
          "id",
          "source",
          "specversion",
          "type",
          "time",
          "datacontenttype",
          "data"
        ],
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique event identifier (UUID v4)",
            "example": "f47ac10b-58cc-4372-a567-0e02b2c3d479"
          },
          "source": {
            "type": "string",
            "description": "Event source URN identifying the Agreement Service",
            "example": "urn:defra:farming:agreement-service"
          },
          "specversion": {
            "type": "string",
            "description": "CloudEvents specification version",
            "const": "1.0",
            "example": "1.0"
          },
          "type": {
            "type": "string",
            "description": "CloudEvents type identifier for agreement status updates",
            "example": "cloud.defra.dev.fg-gas-backend.agreement.status.updated"
          },
          "time": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when the event occurred",
            "example": "2025-01-15T10:30:00.000Z"
          },
          "datacontenttype": {
            "type": "string",
            "description": "Content type of the data payload",
            "const": "application/json",
            "example": "application/json"
          },
          "data": {
            "$ref": "#/components/schemas/AgreementStatusData"
          }
        }
      },
      "AgreementStatusData": {
        "type": "object",
        "description": "Data payload for agreement status update events",
        "required": [
          "agreementNumber",
          "status",
          "date"
        ],
        "properties": {
          "agreementNumber": {
            "type": "string",
            "description": "Unique agreement identifier",
            "example": "SFI123456789"
          },
          "correlationId": {
            "type": "string",
            "description": "Correlation ID for request tracing",
            "example": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
          },
          "clientRef": {
            "type": "string",
            "description": "Client reference from the original application",
            "example": "client-ref-001"
          },
          "version": {
            "type": "integer",
            "description": "Agreement version number",
            "minimum": 1,
            "example": 1
          },
          "agreementUrl": {
            "type": "string",
            "format": "uri",
            "description": "URL to view the agreement (only included for accepted agreements)",
            "example": "https://farming-grants.defra.gov.uk/agreement/SFI123456789"
          },
          "status": {
            "type": "string",
            "description": "New agreement status",
            "enum": [
              "accepted",
              "withdrawn"
            ],
            "example": "accepted"
          },
          "date": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when the status change occurred",
            "example": "2025-01-15T10:30:00.000Z"
          },
          "code": {
            "type": "string",
            "description": "Scheme code identifier",
            "example": "frps-private-beta"
          },
          "endDate": {
            "type": "string",
            "format": "date",
            "description": "Agreement end date (YYYY-MM-DD)",
            "example": "2027-10-31"
          }
        }
      },
      "Identifiers": {
        "type": "object",
        "description": "Business and customer identifiers",
        "required": [
          "sbi"
        ],
        "properties": {
          "sbi": {
            "type": "string",
            "description": "Single Business Identifier - unique identifier for the farming business",
            "example": "106284736"
          },
          "frn": {
            "type": "string",
            "description": "Firm Reference Number",
            "example": "1234567890"
          },
          "crn": {
            "type": "string",
            "description": "Customer Reference Number",
            "example": "CRN123456"
          },
          "defraId": {
            "type": "string",
            "description": "Defra customer identity ID",
            "example": "defra-id-123"
          }
        }
      },
      "Address": {
        "type": "object",
        "description": "Postal address",
        "properties": {
          "line1": {
            "type": "string",
            "description": "Address line 1",
            "example": "Mason House Farm Clitheroe Rd"
          },
          "line2": {
            "type": "string",
            "description": "Address line 2",
            "example": "Bashall Eaves"
          },
          "line3": {
            "type": "string",
            "nullable": true,
            "description": "Address line 3"
          },
          "line4": {
            "type": "string",
            "nullable": true,
            "description": "Address line 4"
          },
          "line5": {
            "type": "string",
            "nullable": true,
            "description": "Address line 5"
          },
          "street": {
            "type": "string",
            "description": "Street name",
            "example": "Bartindale Road"
          },
          "city": {
            "type": "string",
            "description": "City or town",
            "example": "Clitheroe"
          },
          "postalCode": {
            "type": "string",
            "description": "Postal code",
            "example": "BB7 3DD"
          }
        }
      },
      "Application": {
        "type": "object",
        "description": "Application details including land parcels and actions",
        "properties": {
          "parcel": {
            "type": "array",
            "description": "List of land parcels included in the application",
            "items": {
              "$ref": "#/components/schemas/Parcel"
            }
          }
        }
      },
      "Parcel": {
        "type": "object",
        "description": "Land parcel with associated actions",
        "required": [
          "sheetId",
          "parcelId"
        ],
        "properties": {
          "sheetId": {
            "type": "string",
            "description": "OS map sheet identifier",
            "example": "SD6743"
          },
          "parcelId": {
            "type": "string",
            "description": "Land parcel identifier within the sheet",
            "example": "8083"
          },
          "area": {
            "type": "object",
            "description": "Total area of the parcel",
            "properties": {
              "unit": {
                "type": "string",
                "description": "Unit of measurement",
                "enum": [
                  "ha",
                  "metres"
                ],
                "example": "ha"
              },
              "quantity": {
                "type": "number",
                "description": "Area quantity",
                "example": 5.2182
              }
            }
          },
          "actions": {
            "type": "array",
            "description": "Environmental actions applied to this parcel",
            "items": {
              "$ref": "#/components/schemas/Action"
            }
          }
        }
      },
      "Action": {
        "type": "object",
        "description": "Environmental action applied to a land parcel",
        "required": [
          "code",
          "version",
          "appliedFor"
        ],
        "properties": {
          "code": {
            "type": "string",
            "description": "Action code (e.g., CMOR1, UPL1, SPM4)",
            "example": "CMOR1"
          },
          "version": {
            "type": "integer",
            "description": "Action version number",
            "example": 1
          },
          "durationYears": {
            "type": "integer",
            "description": "Duration of the action in years",
            "example": 3
          },
          "appliedFor": {
            "type": "object",
            "description": "Quantity applied for this action",
            "properties": {
              "unit": {
                "type": "string",
                "description": "Unit of measurement",
                "enum": [
                  "ha",
                  "metres"
                ],
                "example": "ha"
              },
              "quantity": {
                "type": "number",
                "description": "Quantity applied for",
                "example": 4.7575
              }
            }
          }
        }
      },
      "Payment": {
        "type": "object",
        "description": "Payment schedule and calculation details",
        "properties": {
          "agreementStartDate": {
            "type": "string",
            "format": "date",
            "description": "Agreement start date (YYYY-MM-DD)",
            "example": "2024-11-01"
          },
          "agreementEndDate": {
            "type": "string",
            "format": "date",
            "description": "Agreement end date (YYYY-MM-DD)",
            "example": "2027-10-31"
          },
          "frequency": {
            "type": "string",
            "description": "Payment frequency",
            "enum": [
              "Quarterly",
              "Annual"
            ],
            "example": "Quarterly"
          },
          "agreementTotalPence": {
            "type": "integer",
            "description": "Total agreement value in pence over the full term",
            "example": 11270793
          },
          "annualTotalPence": {
            "type": "integer",
            "description": "Annual payment total in pence",
            "example": 6440448
          },
          "parcelItems": {
            "type": "object",
            "description": "Map of parcel-level payment items (keyed by item ID)",
            "additionalProperties": {
              "$ref": "#/components/schemas/ParcelItem"
            }
          },
          "agreementLevelItems": {
            "type": "object",
            "description": "Map of agreement-level payment items (keyed by item ID)",
            "additionalProperties": {
              "$ref": "#/components/schemas/AgreementLevelItem"
            }
          },
          "payments": {
            "type": "array",
            "description": "Scheduled payment instalments",
            "items": {
              "$ref": "#/components/schemas/PaymentInstalment"
            }
          }
        }
      },
      "ParcelItem": {
        "type": "object",
        "description": "Payment line item for a specific parcel action",
        "properties": {
          "code": {
            "type": "string",
            "description": "Action code",
            "example": "SPM4"
          },
          "description": {
            "type": "string",
            "description": "Action description",
            "example": "SPM4: Manage hedgerows"
          },
          "version": {
            "type": "integer",
            "description": "Action version",
            "example": 1
          },
          "unit": {
            "type": "string",
            "description": "Unit of measurement",
            "enum": [
              "ha",
              "metres"
            ],
            "example": "metres"
          },
          "quantity": {
            "type": "number",
            "description": "Quantity covered",
            "example": 95
          },
          "rateInPence": {
            "type": "integer",
            "description": "Payment rate per unit in pence",
            "example": 2565
          },
          "annualPaymentPence": {
            "type": "integer",
            "description": "Annual payment amount in pence",
            "example": 243675
          },
          "sheetId": {
            "type": "string",
            "description": "OS map sheet ID",
            "example": "SD4841"
          },
          "parcelId": {
            "type": "string",
            "description": "Parcel ID",
            "example": "44"
          }
        }
      },
      "AgreementLevelItem": {
        "type": "object",
        "description": "Payment line item at agreement level (not parcel-specific)",
        "properties": {
          "code": {
            "type": "string",
            "description": "Action code",
            "example": "CSAM1"
          },
          "description": {
            "type": "string",
            "description": "CSAM1: Assess soil, produce a soil management plan and test soil organic matter",
            "example": "CSAM1: Assess soil, produce a soil management plan and test soil organic matter"
          },
          "version": {
            "type": "integer",
            "description": "Action version",
            "example": 1
          },
          "annualPaymentPence": {
            "type": "integer",
            "description": "Annual payment amount in pence",
            "example": 27200
          }
        }
      },
      "PaymentInstalment": {
        "type": "object",
        "description": "Individual payment instalment",
        "properties": {
          "totalPaymentPence": {
            "type": "integer",
            "description": "Total payment amount for this instalment in pence",
            "example": 1610119
          },
          "paymentDate": {
            "type": "string",
            "format": "date",
            "description": "Scheduled payment date (YYYY-MM-DD)",
            "example": "2025-12-05"
          },
          "lineItems": {
            "type": "array",
            "description": "Breakdown of payment by item",
            "items": {
              "type": "object",
              "properties": {
                "parcelItemId": {
                  "type": "integer",
                  "description": "Reference to parcelItems key (mutually exclusive with agreementLevelItemId)",
                  "example": 1
                },
                "agreementLevelItemId": {
                  "type": "integer",
                  "description": "Reference to agreementLevelItems key (mutually exclusive with parcelItemId)",
                  "example": 1
                },
                "paymentPence": {
                  "type": "integer",
                  "description": "Payment amount for this line item in pence",
                  "example": 60920
                }
              }
            }
          }
        }
      },
      "Applicant": {
        "type": "object",
        "description": "Applicant business and customer details",
        "properties": {
          "business": {
            "type": "object",
            "description": "Business information",
            "properties": {
              "name": {
                "type": "string",
                "description": "Business trading name",
                "example": "J&S Hartley"
              },
              "email": {
                "type": "object",
                "properties": {
                  "address": {
                    "type": "string",
                    "format": "email",
                    "description": "Business email address"
                  }
                }
              },
              "phone": {
                "type": "object",
                "properties": {
                  "mobile": {
                    "type": "string",
                    "description": "Business phone number",
                    "example": "01234031670"
                  }
                }
              },
              "address": {
                "$ref": "#/components/schemas/Address"
              }
            }
          },
          "customer": {
            "type": "object",
            "description": "Individual customer details",
            "properties": {
              "name": {
                "type": "object",
                "description": "Customer name",
                "properties": {
                  "title": {
                    "type": "string",
                    "description": "Title (e.g., Mr., Mrs., Ms.)",
                    "example": "Mr."
                  },
                  "first": {
                    "type": "string",
                    "description": "First name",
                    "example": "Edward"
                  },
                  "middle": {
                    "type": "string",
                    "description": "Middle name(s)",
                    "example": "Paul"
                  },
                  "last": {
                    "type": "string",
                    "description": "Last name",
                    "example": "Jones"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
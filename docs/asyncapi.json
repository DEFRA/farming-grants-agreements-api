{
  "asyncapi": "2.6.0",
  "info": {
    "title": "Agreement Service Events",
    "version": "1.0.0",
    "description": "Event-driven messaging for the Farming Grants Agreements API. This service consumes agreement creation and update events from SQS queues, and publishes agreement status change notifications to SNS topics. Schemas are generated from Pact contract test data."
  },
  "channels": {
    "sqs/gas_create_agreement": {
      "description": "Queue for creating new agreements from the Grant Application Service (GAS). When a grant application is approved, GAS publishes a message to this queue to trigger agreement creation.",
      "subscribe": {
        "operationId": "handleCreateAgreementEvent",
        "summary": "Handle agreement creation from approved applications",
        "message": {
          "name": "CreateAgreementEvent",
          "title": "Create Agreement Event",
          "summary": "Event triggered when a grant application is approved and an agreement should be created",
          "contentType": "application/json",
          "payload": {
            "$ref": "#/components/schemas/CreateAgreementPayload"
          },
          "examples": [
            {
              "name": "Agreement Created Example (from Pact tests)",
              "payload": {
                "id": "12345678-1234-1234-1234-123456789012",
                "source": "fg-gas-backend",
                "time": "2025-12-15T10:19:06.519Z",
                "specversion": "1.0",
                "type": "cloud.defra.test.fg-gas-backend.agreement.create",
                "datacontenttype": "application/json",
                "data": {
                  "notificationMessageId": "sample-notification-2",
                  "agreementNumber": "SFI987654321",
                  "clientRef": "client-ref-002",
                  "code": "frps-private-beta",
                  "createdAt": "2025-08-19T09:36:45.131Z",
                  "submittedAt": "2025-08-19T09:36:44.509Z",
                  "identifiers": {
                    "sbi": "106284736",
                    "frn": "frn",
                    "crn": "crn"
                  },
                  "answers": {
                    "hasCheckedLandIsUpToDate": true,
                    "agreementName": "Example agreement 2",
                    "scheme": "SFI",
                    "year": 2025,
                    "actionApplications": [],
                    "payment": {
                      "agreementStartDate": "2025-09-01",
                      "agreementEndDate": "2028-09-01",
                      "frequency": "Quarterly",
                      "agreementTotalPence": 96018,
                      "annualTotalPence": 32006,
                      "parcelItems": {
                        "1": {
                          "code": "CMOR1",
                          "description": "CMOR1: Assess moorland and produce a written record",
                          "version": 1,
                          "unit": "ha",
                          "quantity": 4.53411078,
                          "rateInPence": 1060,
                          "annualPaymentPence": 4806,
                          "sheetId": "SD6743",
                          "parcelId": "8083"
                        }
                      },
                      "agreementLevelItems": {
                        "1": {
                          "code": "CMOR1",
                          "description": "CMOR1: Assess moorland and produce a written record",
                          "version": 1,
                          "annualPaymentPence": 27200
                        }
                      },
                      "payments": [
                        {
                          "totalPaymentPence": 8007,
                          "paymentDate": "2025-12-05",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1204
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6803
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2026-03-05",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2026-06-05",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2026-09-07",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2026-12-07",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2027-03-05",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2027-06-07",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2027-09-06",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2027-12-06",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2028-03-06",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2028-06-05",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        },
                        {
                          "totalPaymentPence": 8001,
                          "paymentDate": "2028-09-05",
                          "lineItems": [
                            {
                              "parcelItemId": 1,
                              "paymentPence": 1201
                            },
                            {
                              "agreementLevelItemId": 1,
                              "paymentPence": 6800
                            }
                          ]
                        }
                      ]
                    },
                    "applicant": {
                      "business": {
                        "name": "J&S Hartley",
                        "email": {
                          "address": "cliffspencetasabbeyfarmf@mrafyebbasatecnepsffilcm.com.test"
                        },
                        "phone": "01234031670",
                        "address": {
                          "line1": "Mason House Farm Clitheroe Rd",
                          "line2": "Bashall Eaves",
                          "line3": null,
                          "line4": null,
                          "line5": null,
                          "street": "Bartindale Road",
                          "city": "Clitheroe",
                          "postalCode": "BB7 3DD"
                        }
                      },
                      "customer": {
                        "name": {
                          "title": "Mr.",
                          "first": "Edward",
                          "middle": "Paul",
                          "last": "Jones"
                        }
                      }
                    },
                    "application": {
                      "parcel": [
                        {
                          "sheetId": "SD6743",
                          "parcelId": "8083",
                          "area": {
                            "unit": "ha",
                            "quantity": 5.2182,
                            "_id": "69262bb2331fd3b45b76ee92"
                          },
                          "actions": [
                            {
                              "code": "CMOR1",
                              "version": 1,
                              "durationYears": 3,
                              "appliedFor": {
                                "unit": "ha",
                                "quantity": 4.7575,
                                "_id": "69262bb2331fd3b45b76ee94"
                              },
                              "_id": "69262bb2331fd3b45b76ee93"
                            }
                          ],
                          "_id": "69262bb2331fd3b45b76ee91"
                        },
                        {
                          "sheetId": "SD6743",
                          "parcelId": "8333",
                          "area": {
                            "unit": "ha",
                            "quantity": 2.1703,
                            "_id": "69262bb2331fd3b45b76ee98"
                          },
                          "actions": [
                            {
                              "code": "CMOR1",
                              "version": 1,
                              "durationYears": 3,
                              "appliedFor": {
                                "unit": "ha",
                                "quantity": 2.1705,
                                "_id": "69262bb2331fd3b45b76ee9a"
                              },
                              "_id": "69262bb2331fd3b45b76ee99"
                            }
                          ],
                          "_id": "69262bb2331fd3b45b76ee97"
                        }
                      ],
                      "agreement": [],
                      "_id": "69262bb2331fd3b45b76ee90"
                    }
                  }
                }
              }
            }
          ]
        }
      }
    },
    "sqs/gas_application_updated": {
      "description": "Queue for application status updates from GAS. Currently handles withdrawal events to update agreement status accordingly.",
      "subscribe": {
        "operationId": "handleUpdateAgreementEvent",
        "summary": "Handle application status updates (e.g., withdrawn)",
        "message": {
          "name": "UpdateAgreementEvent",
          "title": "Update Agreement Event",
          "summary": "Event triggered when an application status changes (e.g., withdrawn)",
          "contentType": "application/json",
          "payload": {
            "$ref": "#/components/schemas/UpdateAgreementPayload"
          },
          "examples": [
            {
              "name": "Agreement Withdrawn Example (from Pact tests)",
              "payload": {
                "id": "12345678-1234-1234-1234-123456789012",
                "source": "fg-gas-backend",
                "specversion": "1.0",
                "type": "cloud.defra.test.fg-gas-backend.agreement.withdraw",
                "datacontenttype": "application/json",
                "data": {
                  "clientRef": "client-ref-002",
                  "agreementNumber": "SFI987654321",
                  "status": "withdrawn"
                }
              }
            }
          ]
        }
      }
    },
    "sns/agreement_status_updated": {
      "description": "SNS topic for agreement status change notifications. Published when an agreement is accepted by the farmer or withdrawn. Consumers include GAS and other downstream services.",
      "publish": {
        "operationId": "publishAgreementStatusUpdated",
        "summary": "Publish agreement status change notification",
        "message": {
          "name": "AgreementStatusUpdatedEvent",
          "title": "Agreement Status Updated Event",
          "summary": "CloudEvents 1.0 formatted notification when agreement status changes",
          "contentType": "application/json",
          "payload": {
            "$ref": "#/components/schemas/AgreementStatusUpdatedPayload"
          },
          "examples": [
            {
              "name": "Agreement Status Updated Example",
              "payload": {
                "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
                "source": "urn:defra:farming:agreement-service",
                "specversion": "1.0",
                "type": "cloud.defra.dev.fg-gas-backend.agreement.status.updated",
                "time": "2025-01-15T10:30:00.000Z",
                "datacontenttype": "application/json",
                "data": {
                  "agreementNumber": "SFI987654321",
                  "correlationId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                  "clientRef": "client-ref-002",
                  "version": 1,
                  "status": "accepted",
                  "date": "2025-01-15T10:30:00.000Z",
                  "code": "frps-private-beta",
                  "endDate": "2027-10-31"
                }
              }
            }
          ]
        }
      }
    }
  },
  "components": {
    "schemas": {
      "CreateAgreementPayload": {
        "type": "object",
        "description": "CloudEvents 1.0 payload for creating a new agreement from an approved application",
        "required": [
          "type",
          "data"
        ],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique event identifier (UUID)"
          },
          "source": {
            "type": "string",
            "description": "Event source identifier",
            "example": "fg-gas-backend"
          },
          "time": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp"
          },
          "specversion": {
            "type": "string",
            "const": "1.0",
            "description": "CloudEvents specification version"
          },
          "type": {
            "type": "string",
            "description": "Event type identifier. Must contain \"gas-backend.agreement.create\"",
            "example": "cloud.defra.test.fg-gas-backend.agreement.create"
          },
          "datacontenttype": {
            "type": "string",
            "const": "application/json"
          },
          "data": {
            "$ref": "#/components/schemas/AgreementData"
          }
        }
      },
      "UpdateAgreementPayload": {
        "type": "object",
        "description": "CloudEvents 1.0 payload for updating agreement status",
        "required": [
          "data"
        ],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique event identifier (UUID)"
          },
          "source": {
            "type": "string",
            "description": "Event source identifier"
          },
          "specversion": {
            "type": "string",
            "const": "1.0"
          },
          "type": {
            "type": "string",
            "description": "Event type identifier",
            "example": "cloud.defra.test.fg-gas-backend.agreement.withdraw"
          },
          "datacontenttype": {
            "type": "string",
            "const": "application/json"
          },
          "data": {
            "type": "object",
            "required": [
              "clientRef",
              "agreementNumber",
              "status"
            ],
            "properties": {
              "clientRef": {
                "type": "string",
                "description": "Client reference number"
              },
              "agreementNumber": {
                "type": "string",
                "description": "Agreement number"
              },
              "status": {
                "type": "string",
                "enum": [
                  "withdrawn"
                ],
                "description": "New status"
              }
            }
          }
        }
      },
      "AgreementStatusUpdatedPayload": {
        "type": "object",
        "description": "CloudEvents 1.0 formatted payload for agreement status updates",
        "required": [
          "id",
          "source",
          "specversion",
          "type",
          "time",
          "datacontenttype",
          "data"
        ],
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique event identifier (UUID v4)"
          },
          "source": {
            "type": "string",
            "description": "Event source URN",
            "example": "urn:defra:farming:agreement-service"
          },
          "specversion": {
            "type": "string",
            "const": "1.0"
          },
          "type": {
            "type": "string",
            "description": "CloudEvents type identifier",
            "example": "cloud.defra.dev.fg-gas-backend.agreement.status.updated"
          },
          "time": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp"
          },
          "datacontenttype": {
            "type": "string",
            "const": "application/json"
          },
          "data": {
            "type": "object",
            "required": [
              "agreementNumber",
              "status",
              "date"
            ],
            "properties": {
              "agreementNumber": {
                "type": "string"
              },
              "correlationId": {
                "type": "string"
              },
              "clientRef": {
                "type": "string"
              },
              "version": {
                "type": "integer",
                "minimum": 1
              },
              "agreementUrl": {
                "type": "string",
                "format": "uri"
              },
              "status": {
                "type": "string",
                "enum": [
                  "accepted",
                  "withdrawn"
                ]
              },
              "date": {
                "type": "string",
                "format": "date-time"
              },
              "code": {
                "type": "string"
              },
              "endDate": {
                "type": "string",
                "format": "date"
              }
            }
          }
        }
      },
      "AgreementData": {
        "type": "object",
        "description": "Complete agreement data structure (generated from Pact test sample data)",
        "properties": {
          "notificationMessageId": {
            "type": "string"
          },
          "agreementNumber": {
            "type": "string"
          },
          "clientRef": {
            "type": "string"
          },
          "code": {
            "type": "string"
          },
          "identifiers": {
            "$ref": "#/components/schemas/Identifiers"
          },
          "answers": {
            "type": "object",
            "properties": {
              "agreementName": {
                "type": "string"
              },
              "actionApplications": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "sheetId": {
                      "type": "string"
                    },
                    "parcelId": {
                      "type": "string"
                    },
                    "code": {
                      "type": "string"
                    },
                    "appliedFor": {
                      "type": "object",
                      "properties": {
                        "quantity": {
                          "type": "number"
                        },
                        "unit": {
                          "type": "string",
                          "enum": [
                            "ha",
                            "metres"
                          ]
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "applicant": {
            "$ref": "#/components/schemas/Applicant"
          },
          "payment": {
            "$ref": "#/components/schemas/Payment"
          }
        }
      },
      "Identifiers": {
        "type": "object",
        "description": "Business and customer identifiers",
        "properties": {
          "sbi": {
            "type": "string",
            "description": "",
            "example": "106284736"
          },
          "frn": {
            "type": "string",
            "description": "",
            "example": "frn"
          },
          "crn": {
            "type": "string",
            "description": "",
            "example": "crn"
          }
        },
        "required": [
          "sbi",
          "frn",
          "crn"
        ]
      },
      "Application": {
        "type": "object",
        "description": "Application details including land parcels and actions",
        "properties": {
          "parcel": {
            "type": "array",
            "items": {
              "type": "object"
            }
          }
        }
      },
      "Parcel": {
        "type": "object",
        "description": "Land parcel with associated actions",
        "properties": {
          "sheetId": {
            "type": "string"
          },
          "parcelId": {
            "type": "string"
          },
          "area": {
            "type": "object"
          },
          "actions": {
            "type": "array"
          }
        }
      },
      "Action": {
        "type": "object",
        "description": "Environmental action applied to a land parcel",
        "properties": {
          "code": {
            "type": "string"
          },
          "version": {
            "type": "integer"
          },
          "appliedFor": {
            "type": "object"
          }
        }
      },
      "Payment": {
        "type": "object",
        "description": "Payment schedule and calculation details",
        "properties": {
          "agreementStartDate": {
            "type": "string",
            "description": "",
            "example": "2024-11-01"
          },
          "agreementEndDate": {
            "type": "string",
            "description": "",
            "example": "2027-10-31"
          },
          "frequency": {
            "type": "string",
            "description": "",
            "example": "Quarterly"
          },
          "agreementTotalPence": {
            "type": "number",
            "description": "",
            "example": 11270793
          },
          "annualTotalPence": {
            "type": "number",
            "description": "",
            "example": 6440448
          }
        },
        "required": [
          "agreementStartDate",
          "agreementEndDate",
          "frequency",
          "agreementTotalPence",
          "annualTotalPence"
        ]
      },
      "Applicant": {
        "type": "object",
        "description": "Applicant business and customer details",
        "properties": {
          "business": {
            "type": "object",
            "description": "",
            "properties": {
              "name": {
                "type": "string",
                "description": "",
                "example": "J&S Hartley"
              },
              "email": {
                "type": "object",
                "description": "",
                "properties": {
                  "address": {
                    "type": "string",
                    "description": "",
                    "example": "test@example.com"
                  }
                },
                "required": [
                  "address"
                ]
              },
              "phone": {
                "type": "object",
                "description": "",
                "properties": {
                  "mobile": {
                    "type": "string",
                    "description": "",
                    "example": "01234031670"
                  }
                },
                "required": [
                  "mobile"
                ]
              },
              "address": {
                "type": "object",
                "description": "",
                "properties": {
                  "line1": {
                    "type": "string",
                    "description": "",
                    "example": "Mason House Farm Clitheroe Rd"
                  },
                  "line2": {
                    "type": "string",
                    "description": "",
                    "example": "Bashall Eaves"
                  },
                  "street": {
                    "type": "string",
                    "description": "",
                    "example": "Bartindale Road"
                  },
                  "city": {
                    "type": "string",
                    "description": "",
                    "example": "Clitheroe"
                  },
                  "postalCode": {
                    "type": "string",
                    "description": "",
                    "example": "BB7 3DD"
                  }
                },
                "required": [
                  "line1",
                  "line2",
                  "street",
                  "city",
                  "postalCode"
                ]
              }
            },
            "required": [
              "name",
              "email",
              "phone",
              "address"
            ]
          },
          "customer": {
            "type": "object",
            "description": "",
            "properties": {
              "name": {
                "type": "object",
                "description": "",
                "properties": {
                  "title": {
                    "type": "string",
                    "description": "",
                    "example": "Mr."
                  },
                  "first": {
                    "type": "string",
                    "description": "",
                    "example": "Edward"
                  },
                  "middle": {
                    "type": "string",
                    "description": "",
                    "example": "Paul"
                  },
                  "last": {
                    "type": "string",
                    "description": "",
                    "example": "Jones"
                  }
                },
                "required": [
                  "title",
                  "first",
                  "middle",
                  "last"
                ]
              }
            },
            "required": [
              "name"
            ]
          }
        },
        "required": [
          "business",
          "customer"
        ]
      },
      "Address": {
        "type": "object",
        "description": "Postal address",
        "properties": {
          "line1": {
            "type": "string",
            "description": "",
            "example": "Mason House Farm Clitheroe Rd"
          },
          "line2": {
            "type": "string",
            "description": "",
            "example": "Bashall Eaves"
          },
          "street": {
            "type": "string",
            "description": "",
            "example": "Bartindale Road"
          },
          "city": {
            "type": "string",
            "description": "",
            "example": "Clitheroe"
          },
          "postalCode": {
            "type": "string",
            "description": "",
            "example": "BB7 3DD"
          }
        },
        "required": [
          "line1",
          "line2",
          "street",
          "city",
          "postalCode"
        ]
      }
    }
  }
}